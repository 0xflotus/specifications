runOn:
    -
        minServerVersion: "4.3.0"
        topology: ["replicaset, sharded"]

database_name: &database_name "transaction-tests"
collection_name: &collection_name "test"

data: []
tests:
  - description: abortTransaction only retries once after RetryableWriteError from server
    clientOptions:
      retryWrites: false
    failPoint:
      configureFailPoint: failCommand
      mode: { times: 2 }
      data:
        failCommands: ["abortTransaction"]
        errorLabels: ["RetryableWriteError"]
    operations:
      - name: startTransaction
        object: session0
      - name: insertOne
        object: collection
        arguments:
        session: session0
        document:
          _id: 1
        result:
          insertedId: 1
      - name: abortTransaction
        object: session0
    expectations:
      - command_started_event:
          command:
            insert: *collection_name
            documents:
              - _id: 1
            ordered: true
            readConcern:
            lsid: session0
            txnNumber:
              $numberLong: "1"
            startTransaction: true
            autocommit: false
            writeConcern:
          command_name: insert
          database_name: *database_name
      - command_started_event:
          command:
            abortTransaction: 1
            lsid: session0
            txnNumber:
            $numberLong: "1"
            startTransaction:
            autocommit: false
            writeConcern:
          command_name: abortTransaction
          database_name: admin
      - command_started_event:
          command:
            abortTransaction: 1
            lsid: session0
            txnNumber:
            $numberLong: "1"
            startTransaction:
            autocommit: false
            writeConcern:
          command_name: abortTransaction
          database_name: admin
    outcome:
      collection:
        data: []

  - description: abortTransaction does not retry without RetryableWriteError label
    clientOptions:
      retryWrites: false
    failPoint:
      configureFailPoint: failCommand
      mode: { times: 1 }
      data:
        failCommands: ["abortTransaction"]
        errorLabels: []
    operations:
      - name: startTransaction
        object: session0
      - name: insertOne
        object: collection
        arguments:
          session: session0
          document:
            _id: 1
          result:
            insertedId: 1
      - name: abortTransaction
        object: session0
    expectations:
      - command_started_event:
        command:
          insert: *collection_name
          documents:
            - _id: 1
          ordered: true
          readConcern:
          lsid: session0
          txnNumber:
            $numberLong: "1"
          startTransaction: true
          autocommit: false
          writeConcern:
        command_name: insert
        database_name: *database_name
      - command_started_event:
          command:
            abortTransaction: 1
            lsid: session0
            txnNumber:
            $numberLong: "1"
            startTransaction:
            autocommit: false
            writeConcern:
          command_name: abortTransaction
          database_name: admin
    outcome:
      collection:
          data: []

  - description: abortTransaction retries once after network exception
    clientOptions:
      retryWrites: false
    failPoint:
      configureFailPoint: failCommand
      mode: { times: 1 }
      data:
        failCommands: ["abortTransaction"]
        closeConnection: true
    operations:
      - name: startTransaction
        object: session0
      - name: insertOne
        object: collection
        arguments:
          session: session0
          document:
            _id: 1
          result:
            insertedId: 1
      - name: abortTransaction
        object: session0
    expectations:
      - command_started_event:
        command:
          insert: *collection_name
          documents:
            - _id: 1
          ordered: true
          readConcern:
          lsid: session0
          txnNumber:
            $numberLong: "1"
          startTransaction: true
          autocommit: false
          writeConcern:
        command_name: insert
        database_name: *database_name
      - command_started_event:
        command:
          abortTransaction: 1
          lsid: session0
          txnNumber:
          $numberLong: "1"
          startTransaction:
          autocommit: false
          writeConcern:
        command_name: abortTransaction
        database_name: admin
      - command_started_event:
        command:
          abortTransaction: 1
          lsid: session0
          txnNumber:
          $numberLong: "1"
          startTransaction:
          autocommit: false
          writeConcern:
        command_name: abortTransaction
        database_name: admin
    outcome:
      collection:
        data: []
