<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>Server Selection</title>
<meta name="author" content="David Golden" />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="server-selection">
<h1 class="title">Server Selection</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr class="field"><th class="docinfo-name">Spec:</th><td class="field-body">103</td>
</tr>
<tr class="field"><th class="docinfo-name">Title:</th><td class="field-body">Server Selection</td>
</tr>
<tr><th class="docinfo-name">Author:</th>
<td>David Golden</td></tr>
<tr class="field"><th class="docinfo-name">Lead:</th><td class="field-body">Bernie Hackett</td>
</tr>
<tr class="field"><th class="docinfo-name">Advisors:</th><td class="field-body">A. Jesse Jiryu Davis, Samantha Ritter, Robert Stam, Jeff Yemin</td>
</tr>
<tr><th class="docinfo-name">Status:</th>
<td>Accepted</td></tr>
<tr class="field"><th class="docinfo-name">Type:</th><td class="field-body">Standards</td>
</tr>
<tr class="field"><th class="docinfo-name">Last Modified:</th><td class="field-body">February 6, 2015</td>
</tr>
</tbody>
</table>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id1">Abstract</a></li>
<li><a class="reference internal" href="#meta" id="id2">Meta</a></li>
<li><a class="reference internal" href="#motivation-for-change" id="id3">Motivation for Change</a></li>
<li><a class="reference internal" href="#specification" id="id4">Specification</a><ul>
<li><a class="reference internal" href="#scope-and-general-requirements" id="id5">Scope and general requirements</a></li>
<li><a class="reference internal" href="#terms" id="id6">Terms</a></li>
<li><a class="reference internal" href="#assumptions" id="id7">Assumptions</a></li>
<li><a class="reference internal" href="#mongoclient-configuration" id="id8">MongoClient Configuration</a><ul>
<li><a class="reference internal" href="#localthresholdms" id="id9">localThresholdMS</a></li>
<li><a class="reference internal" href="#serverselectiontimeoutms" id="id10">serverSelectionTimeoutMS</a></li>
<li><a class="reference internal" href="#heartbeatfrequencyms" id="id11">heartbeatFrequencyMS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#read-preference" id="id12">Read Preference</a><ul>
<li><a class="reference internal" href="#components-of-a-read-preference" id="id13">Components of a read preference</a><ul>
<li><a class="reference internal" href="#mode" id="id14">mode</a></li>
<li><a class="reference internal" href="#tag-sets" id="id15">tag_sets</a></li>
</ul>
</li>
<li><a class="reference internal" href="#read-preference-configuration" id="id16">Read preference configuration</a></li>
<li><a class="reference internal" href="#passing-read-preference-to-mongos" id="id17">Passing read preference to mongos</a></li>
<li><a class="reference internal" href="#use-of-read-preferences-with-commands" id="id18">Use of read preferences with commands</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rules-for-server-selection" id="id19">Rules for server selection</a><ul>
<li><a class="reference internal" href="#general-server-selection-algorithm" id="id20">General server selection algorithm</a></li>
<li><a class="reference internal" href="#multi-threaded-or-asynchronous-server-selection" id="id21">Multi-threaded or asynchronous server selection</a></li>
<li><a class="reference internal" href="#single-threaded-server-selection" id="id22">Single-threaded server selection</a></li>
<li><a class="reference internal" href="#topology-type-unknown" id="id23">Topology type: Unknown</a></li>
<li><a class="reference internal" href="#topology-type-single" id="id24">Topology type: Single</a></li>
<li><a class="reference internal" href="#topology-types-replicasetwithprimary-or-replicasetnoprimary" id="id25">Topology types: ReplicaSetWithPrimary or ReplicaSetNoPrimary</a><ul>
<li><a class="reference internal" href="#read-operations" id="id26">Read operations</a></li>
<li><a class="reference internal" href="#write-operations" id="id27">Write operations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#topology-type-sharded" id="id28">Topology type: Sharded</a></li>
</ul>
</li>
<li><a class="reference internal" href="#round-trip-times-and-the-latency-window" id="id29">Round Trip Times and the Latency Window</a><ul>
<li><a class="reference internal" href="#calculation-of-average-round-trip-times" id="id30">Calculation of Average Round Trip Times</a></li>
<li><a class="reference internal" href="#selecting-servers-within-the-latency-window" id="id31">Selecting servers within the latency window</a></li>
</ul>
</li>
<li><a class="reference internal" href="#requests-and-pinning-deprecated" id="id32">Requests and Pinning Deprecated</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reference-implementation" id="id33">Reference Implementation</a></li>
<li><a class="reference internal" href="#implementation-notes" id="id34">Implementation Notes</a><ul>
<li><a class="reference internal" href="#modes" id="id35">Modes</a><ul>
<li><a class="reference internal" href="#primarypreferred-and-secondarypreferred" id="id36">primaryPreferred and secondaryPreferred</a></li>
<li><a class="reference internal" href="#nearest" id="id37">nearest</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tag-set-lists" id="id38">Tag set lists</a></li>
<li><a class="reference internal" href="#multi-threaded-server-selection-implementation" id="id39">Multi-threaded server selection implementation</a></li>
<li><a class="reference internal" href="#single-threaded-server-selection-implementation" id="id40">Single-threaded server selection implementation</a></li>
<li><a class="reference internal" href="#server-selection-errors" id="id41">Server Selection Errors</a></li>
<li><a class="reference internal" href="#use-of-slaveok" id="id42">Use of slaveOk</a></li>
<li><a class="reference internal" href="#cursors" id="id43">Cursors</a></li>
<li><a class="reference internal" href="#the-text-command-and-mongos" id="id44">The 'text' command and mongos</a></li>
</ul>
</li>
<li><a class="reference internal" href="#test-plan" id="id45">Test Plan</a></li>
<li><a class="reference internal" href="#design-rationale" id="id46">Design Rationale</a><ul>
<li><a class="reference internal" href="#use-of-topology-types" id="id47">Use of topology types</a></li>
<li><a class="reference internal" href="#consistency-with-mongos" id="id48">Consistency with mongos</a></li>
<li><a class="reference internal" href="#new-localthresholdms-configuration-option-name" id="id49">New localThresholdMS configuration option name</a></li>
<li><a class="reference internal" href="#random-selection-within-the-latency-window" id="id50">Random selection within the latency window</a></li>
<li><a class="reference internal" href="#the-slaveok-wire-protocol-flag" id="id51">The slaveOK wire protocol flag</a></li>
<li><a class="reference internal" href="#general-command-method-going-to-primary" id="id52">General command method going to primary</a></li>
<li><a class="reference internal" href="#average-round-trip-time-calculation" id="id53">Average round trip time calculation</a></li>
<li><a class="reference internal" href="#verbose-errors" id="id54">Verbose errors</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility" id="id55">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#questions-and-answers" id="id56">Questions and Answers</a><ul>
<li><a class="reference internal" href="#what-happened-to-pinning" id="id57">What happened to pinning?</a></li>
<li><a class="reference internal" href="#why-change-from-mongos-high-availablity-ha-to-random-selection" id="id58">Why change from mongos High Availablity (HA) to random selection?</a></li>
<li><a class="reference internal" href="#what-happened-to-auto-retry" id="id59">What happened to auto-retry?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#references" id="id60">References</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id1">Abstract</a></h1>
<p>MongoDB deployments may offer more than one server that can service an
operation.  This specification describes how MongoDB drivers and mongos shall
select a server for either read or write operations.  It includes the definition
of a &quot;read preference&quot; document, configuration options, and algorithms for
selecting a server for different deployment topologies.</p>
</div>
<div class="section" id="meta">
<h1><a class="toc-backref" href="#id2">Meta</a></h1>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;,
&quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;,  &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be
interpreted as described in <a class="reference external" href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>.</p>
</div>
<div class="section" id="motivation-for-change">
<h1><a class="toc-backref" href="#id3">Motivation for Change</a></h1>
<p>This specification builds upon the prior &quot;Driver Read Preference&quot;
specification, which had a number of omissions, flaws
or other deficiencies:</p>
<ol class="arabic simple">
<li>Mandating features that implied monotonicity for situations where
monotonicity is not guaranteed</li>
<li>Mandating features that are not supported by mongos</li>
<li>Neglecting to specify a single, standard way to calculate average latency
times</li>
<li>Specifying complex command-helper rules</li>
<li>Omitting rules for applying read preferences to a single server or to
select among multiple mongos servers</li>
<li>Omitting test cases for verification of spec compliance</li>
</ol>
<p>This revision addresses these problems as well as improving structure and
specificity.</p>
<p>Additionally, it adds specifications for server selection more broadly:</p>
<ul class="simple">
<li>Selection of a server for write operations</li>
<li>Server selection retry and timeout</li>
</ul>
</div>
<div class="section" id="specification">
<h1><a class="toc-backref" href="#id4">Specification</a></h1>
<div class="section" id="scope-and-general-requirements">
<h2><a class="toc-backref" href="#id5">Scope and general requirements</a></h2>
<p>This specification describes how MongoDB drivers and mongos select a server
for read and write operations, including commands, OP_QUERY, OP_INSERT, OP_UPDATE,
and OP_DELETE.  For read operations, it describes how drivers and mongos
shall interpret a read preference document.</p>
<p>This specification does not apply to OP_GET_MORE or OP_KILL_CURSORS
operations on cursors, which need to go to the same server that received an
OP_QUERY and returned a cursor ID.</p>
<p>Drivers and mongos MUST conform to the semantics of this document, but SHOULD
use language-appropriate data models or variable names.</p>
<p>This specification does not apply to commands issued for server monitoring or
authentication.</p>
</div>
<div class="section" id="terms">
<h2><a class="toc-backref" href="#id6">Terms</a></h2>
<dl class="docutils">
<dt><strong>Available</strong></dt>
<dd>Describes a server that is believed to be reachable over the network and
able to respond to requests.  A server of type Unknown or PossiblePrimary
is not available; other types are available.</dd>
<dt><strong>Client</strong></dt>
<dd>Software that communicates with a MongoDB deployment.  This includes both
drivers and mongos.</dd>
<dt><strong>Candidate</strong></dt>
<dd>Describes servers in a deployment that enter the selection process,
determined by the read preference <tt class="docutils literal">mode</tt> parameter and the servers' type.
Depending on the <tt class="docutils literal">mode</tt>, candidate servers might only include secondaries
or might apply to all servers in the deployment.</dd>
<dt><strong>Deployment</strong></dt>
<dd>One or more servers that collectively provide access to a single logical
set of MongoDB databases.</dd>
<dt><strong>Command</strong></dt>
<dd>An OP_QUERY operation targeting the '$cmd' collection namespace.</dd>
<dt><strong>Direct connection</strong></dt>
<dd>A driver connection mode that sends all database operations to a single
server without regard for type.</dd>
</dl>
<dl class="docutils" id="eligible">
<dt><strong>Eligible</strong></dt>
<dd>Describes candidate servers that also meet the criterion specified by the
<tt class="docutils literal">tag_sets</tt> read preference parameter.</dd>
<dt><strong>Immediate topology check</strong></dt>
<dd>For a multi-threaded or asynchronous client, this means waking all
server monitors for an immediate check.  For a single-threaded client,
this means a (blocking) scan of all servers.</dd>
<dt><strong>Latency window</strong></dt>
<dd>When choosing between several suitable servers, the latency window is the
range of acceptable RTTs from the shortest RTT to the shortest RTT plus the
local threshold.  E.g. if the shortest RTT is 15ms and the local threshold
is 200ms, then the latency window ranges from 15ms - 215ms.</dd>
<dt><strong>Local threshold</strong></dt>
<dd>The maximum acceptable difference in milliseconds between the shortest RTT
and the longest RTT of servers suitable to be selected.</dd>
<dt><strong>Mode</strong></dt>
<dd>One of several enumerated values used as part of a read preference, defining
which server types are candidates for reads and the semantics for choosing a
specific one.</dd>
<dt><strong>Primary</strong></dt>
<dd>Describes a server of type RSPrimary.</dd>
<dt><strong>Query</strong></dt>
<dd>An OP_QUERY operation targeting a regular (non '$cmd') collection namespace.</dd>
<dt><strong>Read preference</strong></dt>
<dd>The parameters describing which servers in a deployment can receive
read operations, including <tt class="docutils literal">mode</tt> and <tt class="docutils literal">tag_sets</tt>.</dd>
<dt><strong>RS</strong></dt>
<dd>Abbreviation for &quot;replica set&quot;.</dd>
<dt><strong>RTT</strong></dt>
<dd>Abbreviation for &quot;round trip time&quot;.</dd>
<dt><strong>Round trip time</strong></dt>
<dd>The time in milliseconds to execute an <tt class="docutils literal">ismaster</tt> command and
receive a response for a given server.  This spec differentiates between
the RTT of a single <tt class="docutils literal">ismaster</tt> command and a server's <em>average</em> RTT over
several such commands.</dd>
<dt><strong>Secondary</strong></dt>
<dd>A server of type RSSecondary.</dd>
<dt><strong>Server</strong></dt>
<dd>A mongod or mongos process.</dd>
<dt><strong>Server selection</strong></dt>
<dd>The process by which a server is chosen for a database operation out of all
potential servers in a deployment.</dd>
<dt><strong>Server type</strong></dt>
<dd>An enumerated type indicating whether a server is up or down, whether it is
a mongod or mongos, whether it belongs to a replica set and, if so, what
role it serves in the replica set.  See the <a class="reference external" href="https://github.com/mongodb/specifications/tree/master/source/server-discovery-and-monitoring">Server Discovery and Monitoring</a>
spec for more details.</dd>
<dt><strong>Suitable</strong></dt>
<dd>Describes a server that meets all specified criteria for a read or write
operation.</dd>
<dt><strong>Tag</strong></dt>
<dd>A single key/value pair describing either (1) a user-specified
characteristic of a replica set member or (2) a desired characteristic for
the target of a read operation.  The key and value have no semantic meaning
to the driver; they are arbitrary user choices.</dd>
<dt><strong>Tag set</strong></dt>
<dd>A document of zero or more tags.  Each member of a replica set can be
configured with zero or one tag set.</dd>
<dt><strong>Tag set list</strong></dt>
<dd>A list of zero or more tag sets.  A read preference might have a tag set list
used for selecting servers.</dd>
<dt><strong>Topology</strong></dt>
<dd>The state of a deployment, including its type, which servers are
members, and the server types of members.</dd>
<dt><strong>Topology type</strong></dt>
<dd>An enumerated type indicating the semantics for monitoring servers and
selecting servers for database operations.  See the <a class="reference external" href="https://github.com/mongodb/specifications/tree/master/source/server-discovery-and-monitoring">Server Discovery and
Monitoring</a> spec for more details.</dd>
</dl>
</div>
<div class="section" id="assumptions">
<h2><a class="toc-backref" href="#id7">Assumptions</a></h2>
<ol class="arabic simple">
<li>Unless they explicitly override these priorities, we assume our users
prefer their applications to be, in order:<ul>
<li>Predictable: the behavior of the application should not change based on
the deployment type, whether single mongod, replica set or sharded cluster.</li>
<li>Resilient: applications will adapt to topology changes, if possible,
without raising errors or requiring manual reconfiguration.</li>
<li>Low-latency: all else being equal, faster responses to queries and writes
are preferable.</li>
</ul>
</li>
<li>Clients know the state of a deployment based on some form of ongoing
monitoring, following the rules defined in the <a class="reference external" href="https://github.com/mongodb/specifications/tree/master/source/server-discovery-and-monitoring">Server Discovery and
Monitoring</a> spec.<ul>
<li>They know which members are up or down, what their tag sets are, and
their types.</li>
<li>They know average round trip times to each available member.</li>
<li>They detect reconfiguration and the addition or removal of members.</li>
</ul>
</li>
<li>The state of a deployment could change at any time, in between any network
interaction.<ul>
<li>Servers might or might not be reachable; they can change type at any
time, whether due to partitions, elections, or misconfiguration.</li>
<li>Data rollbacks could occur at any time.</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="mongoclient-configuration">
<h2><a class="toc-backref" href="#id8">MongoClient Configuration</a></h2>
<p>Selecting a server requires the following client-level configuration
options:</p>
<div class="section" id="localthresholdms">
<h3><a class="toc-backref" href="#id9">localThresholdMS</a></h3>
<p>This defines the size of the latency window for selecting among multiple
suitable servers. The default is 15 (milliseconds).  It MUST be configurable at
the client level.  It MUST NOT be configurable at the level of a database
object, collection object, or at the level of an individual query.</p>
<p>In the prior read preference specification, <tt class="docutils literal">localThresholdMS</tt> was called
<tt class="docutils literal">secondaryAcceptableLatencyMS</tt> by drivers.  Drivers MUST support the new
name for consistency, but MAY continue to support the legacy name to avoid
a backward-breaking change.</p>
<p>mongos currently uses <tt class="docutils literal">localThreshold</tt> and MAY continue to do so.</p>
</div>
<div class="section" id="serverselectiontimeoutms">
<h3><a class="toc-backref" href="#id10">serverSelectionTimeoutMS</a></h3>
<p>This defines how long to block for server selection before throwing an
exception.  The default is 30,000 (milliseconds).  It MUST be configurable at
the client level.  It MUST NOT be configurable at the level of a database
object, collection object, or at the level of an individual query.</p>
<p>This default value was chosen to be sufficient for a typical server primary
election to complete.  As the server improves the speed of elections, this
number may be revised downward.</p>
<p>Users that can tolerate long delays for server selection when the topology
is in flux can set this higher.  Users that want to &quot;fail fast&quot; when the
topology is in flux can set this to a small number (or to zero).</p>
</div>
<div class="section" id="heartbeatfrequencyms">
<h3><a class="toc-backref" href="#id11">heartbeatFrequencyMS</a></h3>
<p>This is defined in the <a class="reference external" href="https://github.com/mongodb/specifications/tree/master/source/server-discovery-and-monitoring">Server Discovery and Monitoring</a> spec and
controls how topology updates are scheduled.</p>
</div>
</div>
<div class="section" id="read-preference">
<h2><a class="toc-backref" href="#id12">Read Preference</a></h2>
<p>A read preference determines which servers are considered suitable for read
operations.  Read preferences are interpreted differently based on topology
type.  See topology-type-specific server selection rules for details.</p>
<p>When no servers are suitable, the selection might be retried or will eventually
fail following the rules described in the <a class="reference internal" href="#rules-for-server-selection">Rules for server selection</a>
section.</p>
<div class="section" id="components-of-a-read-preference">
<h3><a class="toc-backref" href="#id13">Components of a read preference</a></h3>
<p>A read preference is a document with a <tt class="docutils literal">mode</tt> field and an optional
<tt class="docutils literal">tag_sets</tt> field.  The <tt class="docutils literal">mode</tt> field prioritizes between primaries and
secondaries to produce either a single, suitable server or a list of candidate
servers.  The <tt class="docutils literal">tag_sets</tt> field might then be applied in some cases to determine
which candidate servers are considered eligible for selection.</p>
<p>The <tt class="docutils literal">mode</tt> field defaults to 'primary'.  The <tt class="docutils literal">tag_sets</tt> field defaults
to a list with an empty document <tt class="docutils literal"><span class="pre">[{}]</span></tt>.</p>
<p>Each is explained in greater detail below.</p>
<div class="section" id="mode">
<h4><a class="toc-backref" href="#id14">mode</a></h4>
<p>For a deployment with topology type ReplicaSetWithPrimary or
ReplicaSetNoPrimary, the <tt class="docutils literal">mode</tt> parameter controls whether primaries or
secondaries are deemed suitable.  Topology types Single and Sharded have
different selection criteria and are described elsewhere.</p>
<p>Clients MUST support these modes:</p>
<dl class="docutils">
<dt><strong>primary</strong></dt>
<dd>Only an available primary is suitable.</dd>
<dt><strong>secondary</strong></dt>
<dd>All secondaries (and <em>only</em> secondaries) are candidates, but only
<a class="reference internal" href="#eligible">eligible</a> candidates (i.e. after applying <tt class="docutils literal">tag_sets</tt>) are suitable.</dd>
<dt><strong>primaryPreferred</strong></dt>
<dd>If a primary is available, only the primary is suitable.  Otherwise,
all secondaries are candidates, but only eligible secondaries are suitable.</dd>
<dt><strong>secondaryPreferred</strong></dt>
<dd>All secondaries are candidates. If there is at least one eligible
secondary, only eligible secondaries are suitable.  Otherwise, when there
are no eligible secondaries, the primary is suitable.</dd>
<dt><strong>nearest</strong></dt>
<dd>The primary and all secondaries are candidates, but only eligible
candidates are suitable.</dd>
</dl>
<p><em>Note on other server types</em>: The <a class="reference external" href="https://github.com/mongodb/specifications/tree/master/source/server-discovery-and-monitoring">Server Discovery and Monitoring</a> spec defines
several other server types that could appear in a replica set.  Such types are never
candidates, eligible or suitable.</p>
</div>
<div class="section" id="tag-sets">
<h4><a class="toc-backref" href="#id15">tag_sets</a></h4>
<p>The read preference <tt class="docutils literal">tag_sets</tt> parameter is an ordered list of tag sets used
to restrict the eligibility of servers, such as for data center awareness.</p>
<p>Clients MUST raise an error if a non-empty tag set is given in <tt class="docutils literal">tag_sets</tt>
and the <tt class="docutils literal">mode</tt> field is 'primary'.</p>
<p>A read preference tag set (<tt class="docutils literal">T</tt>) matches a server tag set (<tt class="docutils literal">S</tt>) –
or equivalently a server tag set (<tt class="docutils literal">S</tt>) matches a read preference
tag set (<tt class="docutils literal">T</tt>) — if <tt class="docutils literal">T</tt> is a subset of <tt class="docutils literal">S</tt> (i.e. <tt class="docutils literal">T ⊆ S</tt>).</p>
<p>For example, the read preference tag set &quot;{ dc: 'ny', rack: 2 }&quot; matches a
secondary server with tag set &quot;{ dc: 'ny', rack: 2, size: 'large' }&quot;.</p>
<p>A tag set that is an empty document matches any server, because the empty
tag set is a subset of any tag set.  This means the default <tt class="docutils literal">tag_sets</tt>
parameter (<tt class="docutils literal"><span class="pre">[{}]</span></tt>) matches all servers.</p>
<p>Eligibility MUST be determined as follows:</p>
<ul class="simple">
<li>If the <tt class="docutils literal">tag_sets</tt> list is empty then all candidates servers are eligible
servers.  (Note, the default of <tt class="docutils literal"><span class="pre">[{}]</span></tt> means an empty list probably won't
often be seen, but if the client does not forbid an empty list, this rule
MUST be implemented to handle that case.)</li>
<li>If the <tt class="docutils literal">tag_sets</tt> list is not empty, then tag sets are tried in order until
a tag set matches at least one candidate server. All candidate servers
matching that tag set are eligible servers.  Subsequent tag sets in the list
are ignored.</li>
<li>If the <tt class="docutils literal">tag_sets</tt> list is not empty and no tag set in the list matches any
candidate server, no servers are eligible servers.</li>
</ul>
</div>
</div>
<div class="section" id="read-preference-configuration">
<h3><a class="toc-backref" href="#id16">Read preference configuration</a></h3>
<p>Drivers MUST allow users to configure a default read preference on a
<tt class="docutils literal">MongoClient</tt> object.  Drivers MAY allow users to configure a default read
preference on a <tt class="docutils literal">Database</tt> or <tt class="docutils literal">Collection</tt> object.</p>
<p>A read preference MAY be specified as an object, document or individual
<tt class="docutils literal">mode</tt> and <tt class="docutils literal">tag_sets</tt> parameters, depending on what is most idiomatic for
the language.</p>
<p>If more than one object has a default read preference, the default of the most
specific object takes precedence.  I.e. <tt class="docutils literal">Collection</tt> is preferred over
<tt class="docutils literal">Database</tt>, which is preferred over <tt class="docutils literal">MongoClient</tt>.</p>
<p>Drivers MAY allow users to set a read preference on queries on a per-operation
basis similar to how <tt class="docutils literal">addSpecial</tt>, <tt class="docutils literal">hint</tt>, or <tt class="docutils literal">batchSize</tt> are set. E.g.,
in Python:</p>
<pre class="literal-block">
db.collection.find({}, read_preference=ReadPreference.SECONDARY)
db.collection.find({},
    read_preference=ReadPreference.NEAREST, tag_sets=[{'dc': 'ny'}])
</pre>
<p>If a driver API allows users to potentially set both the legacy <tt class="docutils literal">slaveOK</tt>
configuration option and a default read preference configuration option,
passing a value for both MUST be an error. (See <a class="reference internal" href="#use-of-slaveok">Use of slaveOk</a> for the two
uses of <tt class="docutils literal">slaveOK</tt>.)</p>
</div>
<div class="section" id="passing-read-preference-to-mongos">
<h3><a class="toc-backref" href="#id17">Passing read preference to mongos</a></h3>
<p>If a server of type Mongos is selected for a read operation, the read
preference is passed to the selected mongos through the use of the
<tt class="docutils literal">slaveOK</tt> wire protocol flag, the <tt class="docutils literal">$readPreference</tt> query
modifier or both, according to the following rules.</p>
<p>If the read preference contains <strong>only</strong> a <tt class="docutils literal">mode</tt> parameter and the mode is
'primary' or 'secondaryPreferred', for maximum backwards compatibility with
older versions of mongos, drivers MUST only use the value of the <tt class="docutils literal">slaveOK</tt>
wire protocol flag (i.e. set or unset) to indicate the desired read preference
and MUST NOT use a <tt class="docutils literal">$readPreference</tt> query modifier.</p>
<p>Therefore, when sending queries to a mongos, the following rules apply:</p>
<blockquote>
<ul class="simple">
<li>For mode 'primary', drivers MUST NOT set the <tt class="docutils literal">slaveOK</tt> wire protocol flag
and MUST NOT use <tt class="docutils literal">$readPreference</tt></li>
<li>For mode 'secondary', drivers MUST set the <tt class="docutils literal">slaveOK</tt> wire protocol flag
and MUST also use <tt class="docutils literal">$readPreference</tt></li>
<li>For mode 'primaryPreferred', drivers MUST set the <tt class="docutils literal">slaveOK</tt> wire protocol flag
and MUST also use <tt class="docutils literal">$readPreference</tt></li>
<li>For mode 'secondaryPreferred', drivers MUST set the <tt class="docutils literal">slaveOK</tt> wire protocol flag.
If the read preference contains a non-empty <tt class="docutils literal">tag_sets</tt> parameter, drivers MUST
use <tt class="docutils literal">$readPreference</tt>; otherwise, drivers MUST NOT use <tt class="docutils literal">$readPreference</tt></li>
<li>For mode 'nearest', drivers MUST set the <tt class="docutils literal">slaveOK</tt> wire protocol flag
and MUST also use <tt class="docutils literal">$readPreference</tt></li>
</ul>
</blockquote>
<p>The <tt class="docutils literal">$readPreference</tt> query modifier sends the read preference as part of the
query.  The read preference fields <tt class="docutils literal">tag_sets</tt> is represented in a <tt class="docutils literal">$readPreference</tt>
document using the field name <tt class="docutils literal">tags</tt>.</p>
<p>When any <tt class="docutils literal">$</tt> modifier is used, including the <tt class="docutils literal">$readPreference</tt> modifier,
the query MUST be provided using the <tt class="docutils literal">$query</tt> modifier like so:</p>
<pre class="literal-block">
{
    $query: {
        field1: 'query_value',
        field2: 'another_query_value'
    },
    $readPreference: {
        mode: 'secondary',
        tags: [ { 'dc': 'ny' } ]
    }
}
</pre>
<p>A valid <tt class="docutils literal">$readPreference</tt> document for mongos has the following requirements:</p>
<ol class="arabic">
<li><p class="first">The <tt class="docutils literal">mode</tt> field MUST be present exactly once with the mode represented
in camel case:</p>
<ul class="simple">
<li>'primary'</li>
<li>'secondary'</li>
<li>'primaryPreferred'</li>
<li>'secondaryPreferred'</li>
<li>'nearest'</li>
</ul>
</li>
<li><p class="first">If the <tt class="docutils literal">mode</tt> field is &quot;primary&quot;, the <tt class="docutils literal">tags</tt> field MUST be absent.</p>
<p>Otherwise, for other <tt class="docutils literal">mode</tt> values, the <tt class="docutils literal">tags</tt> field MUST either be
absent or be present exactly once and have an array value containing at
least one document. It MUST contain only documents, no other type.</p>
</li>
</ol>
<p>Mongos receiving a query with <tt class="docutils literal">$readPreference</tt> SHOULD validate the
<tt class="docutils literal">mode</tt> and <tt class="docutils literal">tags</tt> fields, but SHOULD ignore unrecognized fields for
forward-compatibility rather than throwing an error.</p>
</div>
<div class="section" id="use-of-read-preferences-with-commands">
<h3><a class="toc-backref" href="#id18">Use of read preferences with commands</a></h3>
<p>Because some commands are used for writes, deployment-changes or other
state-changing side-effects, the use of read preference by a driver depends on
the command and how it is invoked:</p>
<ol class="arabic">
<li><p class="first">Write commands: <tt class="docutils literal">insert</tt>, <tt class="docutils literal">update</tt>, <tt class="docutils literal">delete</tt>, <tt class="docutils literal">findAndModify</tt></p>
<p>Write commands are considered write operations and MUST follow the
corresponding <a class="reference internal" href="#rules-for-server-selection">Rules for server selection</a> for each topology type.</p>
</li>
<li><p class="first">Generic command method: typically <tt class="docutils literal">command</tt> or <tt class="docutils literal">runCommand</tt></p>
<p>The generic command method MUST act as a read operation for the purposes of
server selection.</p>
<p>The generic command method has a default read preference of <tt class="docutils literal">mode</tt>
'primary'.  The generic command method MUST ignore any default read
preference from client, database or collection configuration.  The generic
command method SHOULD allow an optional read preference argument.</p>
<p>If an explicit read preference argument is provided as part of the generic
command method call, it MUST be used for server selection, regardless of
the name of the command. It is up to the user to use an appropriate read
preference, e.g.  not calling <tt class="docutils literal">renameCollection</tt> with a <tt class="docutils literal">mode</tt> of
'secondary'.</p>
</li>
<li><p class="first">Command-specific helper: methods that wrap database commands, like
<tt class="docutils literal">count</tt>, <tt class="docutils literal">distinct</tt>, <tt class="docutils literal">listCollections</tt> or <tt class="docutils literal">renameCollection</tt>.</p>
<p>Command-specific helpers MUST act as read operations for the purposes of
server selection, with read preference rules defined by the following three
categories of commands:</p>
<ul>
<li><p class="first">&quot;must-use-primary&quot;:  these commands have state-modifying effects and will
only succeed on a primary.  An example is <tt class="docutils literal">renameCollection</tt>.</p>
<p>These command-specific helpers MUST use a read preference <tt class="docutils literal">mode</tt> of
'primary', MUST NOT take a read preference argument and MUST ignore any
default read preference from client, database or collection
configuration.  Languages with dynamic argument lists MUST throw an error
if a read preference is provided as an argument.</p>
<p>Clients SHOULD rely on the server to return a &quot;not master&quot; or other error
if the command is &quot;must-use-primary&quot;.  Clients MAY raise an exception
before sending the command if the topology type is Single and the server
type is not &quot;Standalone&quot;, &quot;RSPrimary&quot; or &quot;Mongos&quot;, but the identification
of the set of 'must-use-primary' commands is out of scope for this
specification.</p>
</li>
<li><p class="first">&quot;should-use-primary&quot;: these commands are intended to be run on a primary,
but would succeed -- albeit with possibly stale data -- when run against
a secondary.  An example is <tt class="docutils literal">listCollections</tt>.</p>
<p>These command-specific helpers MUST use a read preference <tt class="docutils literal">mode</tt> of
'primary', MUST NOT take a read preference argument and MUST ignore any
default read preference from client, database or collection
configuration.  Languages with dynamic argument lists MUST throw an error
if a read preference is provided as an argument.</p>
<p>Clients MUST NOT raise an exception if the topology type is Single.</p>
</li>
<li><p class="first">&quot;may-use-secondary&quot;: these commands run against primaries or secondaries,
according to users' read preferences.  They are sometimes called
&quot;query-like&quot; commands.</p>
<p>The current list of &quot;may-use-secondary&quot; commands includes:</p>
<blockquote>
<ul class="simple">
<li>group</li>
<li>inline mapreduce</li>
<li>aggregate (without $out specified)</li>
<li>collStats, dbStats</li>
<li>count, distinct</li>
<li>geoNear, geoSearch, geoWalk</li>
<li>parallelCollectionScan</li>
<li>text (but see caveats under <a class="reference internal" href="#the-text-command-and-mongos">The 'text' command and mongos</a>)</li>
</ul>
</blockquote>
<p>Associated command-specific helpers SHOULD take a read preference
argument and otherwise MUST use the default read preference from client,
database or collection configuration.</p>
</li>
</ul>
<p>New command-specific helpers implemented in the future will be considered
&quot;must-use-primary&quot;, &quot;should-use-primary&quot; or &quot;may-use-secondary&quot; according
to the specifications for those future commands.  Command helper
specifications SHOULD use those terms for clarify.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="rules-for-server-selection">
<h2><a class="toc-backref" href="#id19">Rules for server selection</a></h2>
<p>Server selection is a process which takes an operation type (read or write), a
ClusterDescription, and optionally a read preference and, on success, returns a
ServerDescription for an operation of the given type.</p>
<p>Server selection varies depending on whether a client is
multi-threaded/asynchronous or single-threaded because a single-threaded
client cannot rely on the topology state being updated in the background.</p>
<div class="section" id="general-server-selection-algorithm">
<h3><a class="toc-backref" href="#id20">General server selection algorithm</a></h3>
<p>In general, the selection algorithm is as follows:</p>
<ol class="arabic simple">
<li>Record the server selection start time</li>
<li>If the topology wire version is invalid, raise an error</li>
<li>Find suitable servers by topology type and operation type</li>
<li>If there are any suitable servers, choose one at random from those
within the latency window and return it; otherwise, continue to step #5</li>
<li>Request an immediate topology check</li>
<li>If more than <tt class="docutils literal">serverSelectionTimeoutMS</tt> milliseconds have elapsed since
the selection start time, raise a <a class="reference internal" href="#server-selection-error">server selection error</a></li>
<li>Goto Step #2</li>
</ol>
<p>Specific notes and variations for multi- and single-threaded clients are
described below.</p>
</div>
<div class="section" id="multi-threaded-or-asynchronous-server-selection">
<span id="multi-threaded-server-selection"></span><h3><a class="toc-backref" href="#id21">Multi-threaded or asynchronous server selection</a></h3>
<p>A driver that uses multi-threaded or asynchronous monitoring MUST unblock
waiting operations as soon as server selection completes, even if not all
servers have been checked by a monitor.  Put differently, the client MUST NOT
block server selection while waiting for server discovery to finish.</p>
<p>For example, if the client is discovering a replica set and the application
attempts a read operation with mode 'primaryPreferred', the operation MUST
proceed immediately if a suitable secondary is found, rather than blocking
until the client has checked all members and possibly discovered a primary.</p>
<p>The number of threads allowed to wait for server selection SHOULD be either
(a) the same as the number of threads allowed to wait for a connection from
a pool; or (b) governed by a global or client-wide limit on number of
waiting threads, depending on how resource limits are implemented by a
driver.</p>
<p>For multi-threaded clients, the general server selection algorithm is
modified as follows:</p>
<ul class="simple">
<li>In step #5, when no suitable servers are available for an operation, the
client MUST request an immediate topology check, then block the server
selection thread until the topology changes or until the server
selection timeout has elapsed.</li>
</ul>
</div>
<div class="section" id="single-threaded-server-selection">
<h3><a class="toc-backref" href="#id22">Single-threaded server selection</a></h3>
<p>Single-threaded drivers do not monitor the topology in the background.
Instead, they periodically update the topology during server selection.</p>
<p>For such a client, the general server selection algorithm is modified as
follows:</p>
<ul class="simple">
<li>Prior to Step #1, if the topology is marked stale or has not been scanned
in <tt class="docutils literal">heartBeatFrequencyMS</tt> milliseconds, the client MUST do a (blocking)
immediate topology check.</li>
</ul>
<p>Before using a socket to the selected server, drivers MUST check whether
the socket has been used in <tt class="docutils literal">socketCheckIntervalMS</tt> milliseconds (as
defined in the <a class="reference external" href="https://github.com/mongodb/specifications/tree/master/source/server-discovery-and-monitoring">Server Discovery and Monitoring</a> specification).  If the
socket has been idle for longer, the driver MUST update the
ServerDescription for the selected server.  After updating, if the server
is no longer suitable, the driver MUST repeat the server selection
algorithm and select a new server.</p>
</div>
<div class="section" id="topology-type-unknown">
<h3><a class="toc-backref" href="#id23">Topology type: Unknown</a></h3>
<p>When a deployment has topology type &quot;Unknown&quot;, no servers are suitable for read or write
operations.</p>
</div>
<div class="section" id="topology-type-single">
<h3><a class="toc-backref" href="#id24">Topology type: Single</a></h3>
<p>A deployment of topology type Single contains only a single server of any type.
Topology type Single signifies a direct connection intended to receive all read
and write operations.</p>
<p>Therefore, read preference is ignored during server selection with topology
type Single.  The single server is always suitable for reads if it is
available.  Depending on server type, the read preference is communicated
to the server differently:</p>
<ul class="simple">
<li>Type Mongos: the read preference is sent to the server using the rules
for <a class="reference internal" href="#passing-read-preference-to-mongos">Passing read preference to mongos</a>.</li>
<li>For all other types: clients MUST always set the <tt class="docutils literal">slaveOK</tt> wire
protocol flag on reads to ensure that any server type can handle the
request.</li>
</ul>
<p>The single server is always suitable for write operations if it is available.</p>
<p>If the server is a secondary, write operations will fail with a &quot;not master&quot;
error from the server; this is by design and is a consequence of using a direct
connection to a secondary.</p>
</div>
<div class="section" id="topology-types-replicasetwithprimary-or-replicasetnoprimary">
<h3><a class="toc-backref" href="#id25">Topology types: ReplicaSetWithPrimary or ReplicaSetNoPrimary</a></h3>
<p>A deployment with topology type ReplicaSetWithPrimary or ReplicaSetNoPrimary
can have a mix of server types: RSPrimary (only in ReplicaSetWithPrimary),
RSSecondary, RSArbiter, RSOther, RSGhost, Unknown or PossiblePrimary.</p>
<div class="section" id="read-operations">
<h4><a class="toc-backref" href="#id26">Read operations</a></h4>
<p>For the purpose of selecting a server for read operations, the same rules apply
to both topology types.</p>
<p>Servers are suitable if they meet the requirements of the <tt class="docutils literal">mode</tt> and
<tt class="docutils literal">tag_sets</tt> read preference parameters (whether explicit or default).</p>
<p>If more than one server is suitable, clients MUST randomly select a suitable server
within the latency window.</p>
<p>For all read preferences modes except 'primary', clients MUST set the <tt class="docutils literal">slaveOK</tt> wire
protocol flag to ensure that any suitable server can handle the request.  Clients
MUST NOT set the <tt class="docutils literal">slaveOK</tt> wire protocol flag if the read preference mode is
'primary'.</p>
</div>
<div class="section" id="write-operations">
<h4><a class="toc-backref" href="#id27">Write operations</a></h4>
<p>If the topology type is ReplicaSetWithPrimary, only an available primary is
suitable for write operations.</p>
<p>If the topology type is ReplicaSetNoPrimary, no servers are suitable for write
operations.</p>
</div>
</div>
<div class="section" id="topology-type-sharded">
<h3><a class="toc-backref" href="#id28">Topology type: Sharded</a></h3>
<p>A deployment of topology type Sharded contains one or more servers of type
Mongos or Unknown.</p>
<p>For read operations, all servers of type Mongos are suitable; the <tt class="docutils literal">mode</tt>
and <tt class="docutils literal">tag_sets</tt> read preference parameters are ignored for selecting a
server, but are passed through to mongos. See <a class="reference internal" href="#passing-read-preference-to-mongos">Passing read preference to mongos</a>.</p>
<p>For write operations, all servers of type Mongos are suitable.</p>
<p>If more than one mongos is suitable, drivers MUST randomly select a suitable
server within the latency window.</p>
</div>
</div>
<div class="section" id="round-trip-times-and-the-latency-window">
<h2><a class="toc-backref" href="#id29">Round Trip Times and the Latency Window</a></h2>
<div class="section" id="calculation-of-average-round-trip-times">
<h3><a class="toc-backref" href="#id30">Calculation of Average Round Trip Times</a></h3>
<p>For every available server, clients MUST track the average RTT of server
monitoring <tt class="docutils literal">ismaster</tt> commands.</p>
<p>An Unknown server has no average RTT.  When a server becomes unavailable, its
average RTT MUST be cleared.  Clients MAY implement this idiomatically (e.g
nil, -1, etc.).</p>
<p>When there is no average RTT for a server, the average RTT MUST be set equal to
the first RTT measurement (i.e. the first <tt class="docutils literal">ismaster</tt> command after the
server becomes available).</p>
<p>After the first measurement, average RTT MUST be computed using an
exponentially-weighted moving average formula, with a weighting factor
(<tt class="docutils literal">alpha</tt>) of 0.2.  If the prior average is denoted <tt class="docutils literal">old_rtt</tt>, then the new
average (<tt class="docutils literal">new_rtt</tt>) is computed from a new RTT measurement (<tt class="docutils literal">x</tt>) using the
following formula:</p>
<pre class="literal-block">
alpha = 0.2
new_rtt = alpha * x + (1 - alpha) * old_rtt
</pre>
<p>A weighting factor of 0.2 was chosen to put about 85% of the weight of the
average RTT on the 9 most recent observations.</p>
</div>
<div class="section" id="selecting-servers-within-the-latency-window">
<h3><a class="toc-backref" href="#id31">Selecting servers within the latency window</a></h3>
<p>Server selection results in a set of zero or more suitable servers.  If more
than one server is suitable, a server MUST be selected randomly from among
those within the latency window.</p>
<p>The <tt class="docutils literal">localThresholdMS</tt> configuration parameter controls the size of the
latency window used to select a suitable server.</p>
<p>The shortest average RTT from among suitable servers anchors one end of the
latency window (<tt class="docutils literal">A</tt>).  The other end is determined by adding
<tt class="docutils literal">localThresholdMS</tt> (<tt class="docutils literal">B = A + localThresholdMS</tt>).</p>
<p>A server MUST be selected randomly from among suitable servers that have an
average RTT (<tt class="docutils literal">RTT</tt>) within the latency window (i.e. <tt class="docutils literal">A ≤ RTT ≤ B</tt>).</p>
<p>In other words, the suitable server with the shortest average RTT is <strong>always</strong>
a possible choice.  Other servers could be chosen if their average RTTs are no
more than <tt class="docutils literal">localThresholdMS</tt> more than the shortest average RTT.</p>
</div>
</div>
<div class="section" id="requests-and-pinning-deprecated">
<h2><a class="toc-backref" href="#id32">Requests and Pinning Deprecated</a></h2>
<p>The prior read preference specification included the concept of a &quot;request&quot;,
which pinned a server to a thread for subsequent, related reads.  Requests
and pinning are now <strong>deprecated</strong>.  See <a class="reference internal" href="#what-happened-to-pinning">What happened to pinning?</a> for
the rationale for this change.</p>
<p>Drivers with an existing request API MAY continue to provide it for backwards
compatibility, but MUST document that pinning for the request does not
guarantee monotonic reads.</p>
<p>Drivers MUST NOT automatically pin the client or a thread to a particular
server without an explicit <tt class="docutils literal">start_request</tt> (or comparable) method call.</p>
<p>Outside a legacy &quot;request&quot; API, drivers MUST use server selection for each
individual read operation.</p>
</div>
</div>
<div class="section" id="reference-implementation">
<h1><a class="toc-backref" href="#id33">Reference Implementation</a></h1>
<p>The single-threaded reference implementation is the Perl master branch (work
towards v1.0.0).  The multi-threaded reference implementation is TBD.</p>
</div>
<div class="section" id="implementation-notes">
<h1><a class="toc-backref" href="#id34">Implementation Notes</a></h1>
<p>These are suggestions. As always, driver authors should balance cross-language
standardization with backwards compatibility and the idioms of their language.</p>
<div class="section" id="modes">
<h2><a class="toc-backref" href="#id35">Modes</a></h2>
<p>Modes ('primary', 'secondary', ...) are constants declared in whatever way is
idiomatic for the programming language. The constant values may be ints,
strings, or whatever.  However, when attaching modes to <tt class="docutils literal">$readPreference</tt>
camel case must be used as described above in <a class="reference internal" href="#passing-read-preference-to-mongos">Passing read preference to
mongos</a>.</p>
<div class="section" id="primarypreferred-and-secondarypreferred">
<h3><a class="toc-backref" href="#id36">primaryPreferred and secondaryPreferred</a></h3>
<p>'primaryPreferred' is equivalent to selecting a server with read preference mode
'primary' (without <tt class="docutils literal">tag_sets</tt>), or, if that fails, falling back to selecting
with read preference mode 'secondary' (with <tt class="docutils literal">tag_sets</tt>, if provided).</p>
<p>'secondaryPreferred' is the inverse: selecting with mode 'secondary' (with
<tt class="docutils literal">tag_sets</tt>) and falling back to selecting with mode 'primary' (without
<tt class="docutils literal">tag_sets</tt>).</p>
<p>Depending on the implementation, this may result in cleaner code.</p>
</div>
<div class="section" id="nearest">
<h3><a class="toc-backref" href="#id37">nearest</a></h3>
<p>The term 'nearest' is unfortunate, as it implies a choice based on geographic
locality or absolute lowest latency, neither of which are true.</p>
<p>Instead, and unlike the other read preference modes, 'nearest' does not favor
either primaries or secondaries; instead all servers are candidates and are
filtered by <tt class="docutils literal">tag_sets</tt>.</p>
<p>To always select the server with the lowest RTT, users should use mode 'nearest'
without <tt class="docutils literal">tag_sets</tt> and set <tt class="docutils literal">localThresholdMS</tt> to zero.</p>
<p>To distribute reads across all members evenly regardless of RTT, users should
use mode 'nearest' without <tt class="docutils literal">tag_sets</tt> and set <tt class="docutils literal">localThresholdMS</tt> very high so
that all servers fall within the latency window.</p>
<p>In both cases, <tt class="docutils literal">tag_sets</tt> could be used to further restrict the set of eligible
servers, if desired.</p>
</div>
</div>
<div class="section" id="tag-set-lists">
<h2><a class="toc-backref" href="#id38">Tag set lists</a></h2>
<p>Tag set lists can be configured in the driver in whatever way is natural for
the language.</p>
</div>
<div class="section" id="multi-threaded-server-selection-implementation">
<h2><a class="toc-backref" href="#id39">Multi-threaded server selection implementation</a></h2>
<p>The following example uses a single lock for clarity.  Drivers are free to
implement whatever concurrency model best suits their design.</p>
<p>Pseudocode for <a class="reference internal" href="#multi-threaded-server-selection">multi-threaded server selection</a>:</p>
<pre class="literal-block">
def getServer(criteria):
    client.lock.acquire()

    now = gettime()
    endTime = now + serverSelectionTimeoutMS

    while true:
        # The topology keeps track of whether any server has an
        # an invalid wire version range
        if topology wire version range is invalid:
            client.lock.release()
            throw error(&quot;incompatible wire protocol version ranges&quot;)

        servers = all servers in client.topologyDescription matching criteria

        if servers is not empty:
            in_window = servers within the latency window
            selected = random entry from in_window
            client.lock.release()
            return selected

        request that all monitors check immediately

        # Wait for a new TopologyDescription. condition.wait() releases
        # client.lock while waiting and reacquires it before returning.
        # While a thread is waiting on client.condition, it is awakened
        # early whenever a server check completes.
        timeout_left = endTime - gettime()
        client.condition.wait(timeout_left)

        if now after endTime:
            client.lock.release()
            throw server selection error
</pre>
</div>
<div class="section" id="single-threaded-server-selection-implementation">
<h2><a class="toc-backref" href="#id40">Single-threaded server selection implementation</a></h2>
<p>Pseudocode for <a class="reference internal" href="#single-threaded-server-selection">single-threaded server selection</a>:</p>
<pre class="literal-block">
def getServer(criteria):

    rescan all servers if topology is stale

    now = gettime()
    endTime = now + serverSelectionTimeoutMS

    while true:
        # The topology keeps track of whether any server has an
        # an invalid wire version range
        if topology wire version range is invalid:
            throw error(&quot;incompatible wire protocol version ranges&quot;)

        servers = all servers in client.topologyDescription matching criteria

        if servers is not empty:
            in_window = servers within the latency window
            return random entry from in_window

        rescan all servers

        if now after endTime:
            throw server selection error
</pre>
</div>
<div class="section" id="server-selection-errors">
<span id="server-selection-error"></span><h2><a class="toc-backref" href="#id41">Server Selection Errors</a></h2>
<p>Drivers should use server descriptions and their error attributes (if set) to
return useful error messages.</p>
<p>For example, when there are no members matching the ReadPreference:</p>
<ul class="simple">
<li>&quot;No server available for query with ReadPreference primary&quot;</li>
<li>&quot;No server available for query with ReadPreference secondary&quot;</li>
<li>&quot;No server available for query with ReadPreference &quot; + mode + &quot; and tag set list &quot; + tag_sets</li>
</ul>
<p>Or, if authentication failed:</p>
<ul class="simple">
<li>&quot;Authentication failed: [specific error message]&quot;</li>
</ul>
<p>Here is a sketch of some pseudocode for handling error reporting when errors
could be different across servers:</p>
<pre class="literal-block">
if there are any available servers:
    error_message = &quot;No servers are suitable for &quot; + criteria
else if all ServerDescriptions' errors are the same:
    error_message = a ServerDescription.error value
else:
    error_message = ', '.join(all ServerDescriptions' errors)
</pre>
</div>
<div class="section" id="use-of-slaveok">
<h2><a class="toc-backref" href="#id42">Use of slaveOk</a></h2>
<p>There are two usages of <tt class="docutils literal">slaveOK</tt>:</p>
<ol class="arabic simple">
<li>A driver query parameter that predated read preference modes and tag
set lists.</li>
<li>A wire protocol flag on OP_QUERY operations</li>
</ol>
<p>Using <tt class="docutils literal">slaveOk</tt> as a query parameter is deprecated. Until it is removed,
<tt class="docutils literal">slaveOk</tt> used as a method argument or query option is considered
equivalent to a read preference <tt class="docutils literal">mode</tt> of 'secondaryPreferred'</p>
<p>The <tt class="docutils literal">slaveOk</tt> wire protocol flag remains in the wire protocol and drivers
set this bit for each topology type as described in the specification
above.</p>
</div>
<div class="section" id="cursors">
<h2><a class="toc-backref" href="#id43">Cursors</a></h2>
<p>Cursor operations OP_GET_MORE and OP_KILL_CURSOR do not go through the server
selection process.  Cursor operations must be sent to the original server that
received the query and sent the OP_REPLY.  For exhaust cursors, the same socket
must be used for OP_GET_MORE until the cursor is exhausted.</p>
</div>
<div class="section" id="the-text-command-and-mongos">
<h2><a class="toc-backref" href="#id44">The 'text' command and mongos</a></h2>
<p><em>Note</em>: As of MongoDB 2.6, mongos doesn't distribute the &quot;text&quot; command to
secondaries, see <a class="reference external" href="https://jira.mongodb.org/browse/SERVER-10947">SERVER-10947</a>.</p>
<p>However, the &quot;text&quot; command is deprecated in 2.6, so this command-specific
helper may become deprecated before this is fixed.</p>
</div>
</div>
<div class="section" id="test-plan">
<h1><a class="toc-backref" href="#id45">Test Plan</a></h1>
<p>The server selection test plan is given in a separate document that
describes the tests and supporting data files: <a class="reference external" href="https://github.com/mongodb/specifications/blob/master/source/server-selection/server-selection-tests.rst">Server Selection Tests</a></p>
</div>
<div class="section" id="design-rationale">
<h1><a class="toc-backref" href="#id46">Design Rationale</a></h1>
<div class="section" id="use-of-topology-types">
<h2><a class="toc-backref" href="#id47">Use of topology types</a></h2>
<p>The prior version of the read preference spec had only a loose definition of
server or topology types.  The <a class="reference external" href="https://github.com/mongodb/specifications/tree/master/source/server-discovery-and-monitoring">Server Discovery and Monitoring</a> spec defines these terms
explicitly and they are used here for consistency and clarity.</p>
</div>
<div class="section" id="consistency-with-mongos">
<h2><a class="toc-backref" href="#id48">Consistency with mongos</a></h2>
<p>In order to ensure that behavior is consistent regardless of topology type,
read preference behaviors are limited to those that mongos can proxy.</p>
<p>For example, mongos ignores read preference 'secondary' when a shard consists of
a single server.  Therefore, this spec calls for topology type Single to ignore
read preferences for consistency.</p>
<p>The spec has been written with the intention that it can apply to both drivers
and mongos and the term &quot;client&quot; has been used when behaviors should apply to
both.  Behaviors that are specific to drivers are largely limited to those
for communicating with a mongos.</p>
</div>
<div class="section" id="new-localthresholdms-configuration-option-name">
<h2><a class="toc-backref" href="#id49">New localThresholdMS configuration option name</a></h2>
<p>Because this does not apply <strong>only</strong> to secondaries and does not limit absolute
latency, the name <tt class="docutils literal">secondaryAcceptableLatencyMS</tt> is misleading.</p>
<p>The mongos name <tt class="docutils literal">localThreshold</tt> misleads because it has nothing to do with
locality.  It also doesn't include the <tt class="docutils literal">MS</tt> units suffix for consistency with
other time-related configuration options.</p>
<p>However, given a choice between the two, <tt class="docutils literal">localThreshold</tt> is a more general
term.  For drivers, we add the <tt class="docutils literal">MS</tt> suffix for clarity about units and
consistency with other configuration options.</p>
</div>
<div class="section" id="random-selection-within-the-latency-window">
<h2><a class="toc-backref" href="#id50">Random selection within the latency window</a></h2>
<p>When more than one server is judged to be suitable, the spec calls for random
selection to ensure a fair distribution of work among servers within the
latency window.</p>
<p>It would be hard to ensure a fair round-robin approach given the potential for
servers to come and go.  Making newly available servers either first or last
could lead to unbalanced work.  Random selection has a better fairness
guarantee and keeps the design simpler.</p>
</div>
<div class="section" id="the-slaveok-wire-protocol-flag">
<h2><a class="toc-backref" href="#id51">The slaveOK wire protocol flag</a></h2>
<p>In server selection, there is a race condition that could exist between what
a selected server type is believed to be and what it actually is.</p>
<p>The <tt class="docutils literal">slaveOK</tt> wire protocol flag solves the race problem by communicating
to the server whether a secondary is acceptable.  The server knows its type
and can return a &quot;not master&quot; error if <tt class="docutils literal">slaveOK</tt> is false and the server
is a secondary.</p>
<p>However, because topology type Single is used for direct connections, we want
read operations to succeed even against a secondary, so the <tt class="docutils literal">slaveOK</tt> wire
protocol flag must be set for topology type Single.</p>
</div>
<div class="section" id="general-command-method-going-to-primary">
<h2><a class="toc-backref" href="#id52">General command method going to primary</a></h2>
<p>The list of commands that can go to secondaries changes over time and depends
not just on the command but on parameters.  For example, the <tt class="docutils literal">mapReduce</tt>
command may or may not be able to be run on secondaries depending on the value
of the <tt class="docutils literal">out</tt> parameter.</p>
<p>It significantly simplifies implementation for the general command method
always to go to the primary unless a explicit read preference is set and rely
on users of the general command method to provide a read preference appropriate
to the command.</p>
<p>The command-specific helpers will need to implement a check of read preferences
against the semantics of the command and its parameters, but keeping this logic
close to the command rather than in a generic method is a better design than
either delegating this check to the generic method, duplicating the logic in
the generic method, or coupling both to another validation method.</p>
</div>
<div class="section" id="average-round-trip-time-calculation">
<h2><a class="toc-backref" href="#id53">Average round trip time calculation</a></h2>
<p>Using an exponentially-weighted moving average avoids having to store and
rotate an arbitrary number of RTT observations.  All observations count towards
the average.  The weighting makes recent observations count more heavily while
smoothing volatility.</p>
</div>
<div class="section" id="verbose-errors">
<h2><a class="toc-backref" href="#id54">Verbose errors</a></h2>
<p>Error messages should be sufficiently verbose to allow users and/or support
engineers to determine the reasons for server selection failures from log
or other error messages.</p>
</div>
</div>
<div class="section" id="backwards-compatibility">
<h1><a class="toc-backref" href="#id55">Backwards Compatibility</a></h1>
<p>In general, backwards breaking changes have been made in the name of
consistency with mongos and avoiding misleading users about monotonicity.</p>
<ul>
<li><p class="first">Features removed:</p>
<blockquote>
<ul class="simple">
<li>Automatic pinning (see <a class="reference internal" href="#what-happened-to-pinning">What happened to pinning?</a>)</li>
<li>Auto retry (replaced by the general server selection algorithm)</li>
<li>mongos &quot;high availability&quot; mode (effectively, mongos pinning)</li>
</ul>
</blockquote>
</li>
<li><p class="first">Other features and behaviors have changed explicitly</p>
<blockquote>
<ul class="simple">
<li>Ignoring read preferences for topology type Single</li>
<li>Default read preference for the generic command method</li>
</ul>
</blockquote>
</li>
<li><p class="first">Changes with grandfather clauses</p>
<blockquote>
<ul class="simple">
<li>Alternate names for <tt class="docutils literal">localThresholdMS</tt></li>
<li>Pinning for legacy request APIs</li>
</ul>
</blockquote>
</li>
<li><p class="first">Internal changes with little user-visibility</p>
<blockquote>
<ul class="simple">
<li>Clarifying calculation of average RTT</li>
</ul>
</blockquote>
</li>
</ul>
</div>
<div class="section" id="questions-and-answers">
<h1><a class="toc-backref" href="#id56">Questions and Answers</a></h1>
<div class="section" id="what-happened-to-pinning">
<h2><a class="toc-backref" href="#id57">What happened to pinning?</a></h2>
<p>The prior read preference spec, which was implemented in the versions of the
drivers and mongos released concomitantly with MongoDB 2.2, stated that a
thread / client should remain pinned to an RS member as long as that member
matched the current mode, tags, and acceptable latency. This increased the
odds that reads would be monotonic (assuming no rollback),
but had the following surprising consequence:</p>
<ol class="arabic simple">
<li>Thread / client reads with mode 'secondary' or 'secondaryPreferred', gets
pinned to a secondary</li>
<li>Thread / client reads with mode 'primaryPreferred', driver / mongos sees that
the pinned member (a secondary) matches the mode (which <em>allows</em> for a
secondary) and reads from secondary, even though the primary is available and
preferable</li>
</ol>
<p>The old spec also had the swapped problem, reading from the primary with
'secondaryPreferred', except for mongos which was changed at the last minute
before release with <a class="reference external" href="https://jira.mongodb.org/browse/SERVER-6565">SERVER-6565</a> (&quot;Do not use primary if secondaries are
available for slaveOk&quot;).</p>
<p>This left application developers with two problems:</p>
<ol class="arabic simple">
<li>'primaryPreferred' and 'secondaryPreferred' acted surprisingly and
unpredictably within requests</li>
<li>There was no way to specify a common need: read from a secondary if possible
with 'secondaryPreferred', then from primary if possible with 'primaryPreferred',
all within a request. Instead an application developer would have to do the
second read with 'primary', which would unpin the thread but risk unavailability
if only secondaries were up.</li>
</ol>
<p>Additionally, mongos 2.4 introduced the releaseConnectionsAfterResponse option
(RCAR), mongos 2.6 made it the default and mongos 2.8 will remove the ability
to turn it off.  This means that pinning to a mongos offers no guarantee that
connections to shards are pinned.  Since we can't provide the same guarantees
for replica sets and sharded clusters, we removed automatic pinning entirely
and deprecated &quot;requests&quot;. See <a class="reference external" href="https://jira.mongodb.org/browse/SERVER-11956">SERVER-11956</a> and <a class="reference external" href="https://jira.mongodb.org/browse/SERVER-12273">SERVER-12273</a>.</p>
<p>Regardless, even for replica sets, pinning offers no monotonicity because of
the ever-present possibility of rollbacks.  Through MongoDB 2.6, secondaries
did not close sockets on rollback, so a rollback could happen between any two
queries without any indication to the driver.</p>
<p>Therefore, an inconsistent feature that doesn't actually do what people think
it does has no place in the spec and has been removed.  Should the server
eventually implement some form of &quot;sessions&quot;, this spec will need to be revised
accordingly.</p>
</div>
<div class="section" id="why-change-from-mongos-high-availablity-ha-to-random-selection">
<h2><a class="toc-backref" href="#id58">Why change from mongos High Availablity (HA) to random selection?</a></h2>
<p>Mongos HA has similar problems with pinning, in that one can wind up pinned
to a high-latency mongos even if a lower-latency mongos later becomes
available.</p>
<p>Random selection within the latency window avoids this problem and makes server
selection exactly analogous to having multiple suitable servers from a replica
set.  This is easier to explain and implement.</p>
</div>
<div class="section" id="what-happened-to-auto-retry">
<h2><a class="toc-backref" href="#id59">What happened to auto-retry?</a></h2>
<p>The old auto-retry mechanism was closely connected to server pinning, which has
been removed.  It also mandated exactly three attempts to carry out a query on
different servers, with no way to disable or adjust that value, and only for
the first query within a request.</p>
<p>To the extent that auto-retry was trying to compensate for unavailable servers,
the Server Discovery and Monitoring spec and new server selection algorithm
provide a more robust and configurable way to direct <em>all</em> queries to available
servers.</p>
<p>After a server is selected, several error conditions could still occur that
make the selected server unsuitable for sending the operation, such as:</p>
<blockquote>
<ul class="simple">
<li>the server could have shutdown the socket (e.g. a primary stepping down),</li>
<li>a connection pool could be empty, requiring new connections; those
connections could fail to connect or could fail the server handshake</li>
</ul>
</blockquote>
<p>Once an operation is sent over the wire, several additional error conditions
could occur, such as:</p>
<blockquote>
<ul class="simple">
<li>a socket timeout could occur before the server responds</li>
<li>the server might send an RST packet, indicating the socket was already closed</li>
<li>for write operations, the server might return a &quot;not master&quot; error</li>
</ul>
</blockquote>
<p>This specification does not require nor prohibit drivers from attempting
automatic recovery for various cases where it might be considered reasonable to
do so, such as:</p>
<blockquote>
<ul class="simple">
<li>repeating server selection if, after selection, a socket is determined to
be unsuitable before a message is sent on it</li>
<li>for a read operation, after a socket error, selecting a new server
meeting the read preference and resending the query</li>
<li>for a write operation, after a &quot;not master&quot; error, selecting a new server
(to locate the primary) and resending the write operation</li>
</ul>
</blockquote>
<p>Driver-common rules for retrying operations (and configuring such retries)
could be the topic of a different, future specification.</p>
</div>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id60">References</a></h1>
<ul class="simple">
<li><a class="reference external" href="https://github.com/mongodb/specifications/tree/master/source/server-discovery-and-monitoring">Server Discovery and Monitoring</a> specification</li>
<li><a class="reference external" href="https://github.com/mongodb/specifications/blob/master/source/auth">Driver Authentication</a> specification</li>
</ul>
</div>
</div>
</body>
</html>
